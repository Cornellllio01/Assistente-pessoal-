<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Suas credenciais do Supabase (SUBSTITUA PELAS SUAS REAIS! )
    const SUPABASE_URL = 'https://ilnpbrkjutypjuyaeyyk.supabase.co'; // Ex: https://abcdefg12345.supabase.co
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsbnBicmtqdXR5cGp1eWFleXlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyNDQyMzAsImV4cCI6MjA2NjgyMDIzMH0.AE-Hie67CqfEAxO_oT7KDbcOTV7L13658m8OSecY67g'; // Ex: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY );

    let expenses = []; // O array local ainda ser√° usado para renderizar a UI
    let recognition;
    let isListening = false;

    // Inicializar reconhecimento de voz (mantido como estava)
    function initSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
                document.getElementById('status').textContent = 'üé§ Ouvindo... Fale sua despesa';
                document.getElementById('status').className = 'status listening';
            };

            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('transcript').textContent = transcript;
                
                if (event.results[event.results.length - 1].isFinal) {
                    processVoiceCommand(transcript);
                }
            };

            recognition.onend = function() {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('status').textContent = 'Clique no microfone e fale sua despesa';
                document.getElementById('status').className = 'status ready';
                
                setTimeout(() => {
                    isListening = false;
                }, 100);
            };

            recognition.onerror = function(event) {
                console.error('Erro no reconhecimento de voz:', event.error);
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                
                let errorMessage = '';
                let statusClass = 'status ready';
                
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = 'üö´ Permiss√£o negada! Permita o acesso ao microfone e recarregue a p√°gina';
                        statusClass = 'status error';
                        showPermissionHelp();
                        break;
                    case 'no-speech':
                        errorMessage = 'üîá Nenhuma fala detectada. Tente novamente';
                        break;
                    case 'audio-capture':
                        errorMessage = 'üé§ Erro no microfone. Verifique se est√° funcionando';
                        break;
                    case 'network':
                        errorMessage = 'üåê Erro de rede. Verifique sua conex√£o';
                        break;
                    default:
                        errorMessage = 'Erro no reconhecimento. Tente novamente';
                }
                
                document.getElementById('status').textContent = errorMessage;
                document.getElementById('status').className = statusClass;
                
                setTimeout(() => {
                    isListening = false;
                    if (event.error !== 'not-allowed') {
                        document.getElementById('status').textContent = 'Clique no microfone e fale sua despesa';
                        document.getElementById('status').className = 'status ready';
                    }
                }, 3000);
            };
        } else {
            document.getElementById('status').textContent = 'Reconhecimento de voz n√£o suportado no seu navegador';
            document.getElementById('voiceBtn').disabled = true;
        }
    }

    // Processar comando de voz (mantido como estava)
    function processVoiceCommand(transcript) {
        document.getElementById('status').textContent = 'Processando comando...';
        document.getElementById('status').className = 'status processing';

        const expense = parseVoiceCommand(transcript.toLowerCase());
        
        if (expense) {
            addExpense(expense.description, expense.value, expense.category);
            document.getElementById('status').textContent = `‚úÖ Despesa adicionada: ${expense.description} - R$ ${formatCurrency(expense.value)}`; // Usando formatCurrency
            document.getElementById('status').className = 'status ready';
        } else {
            document.getElementById('status').textContent = '‚ùå N√£o consegui entender. Tente: "Gastei 20 reais com almo√ßo"';
            document.getElementById('status').className = 'status ready';
        }

        setTimeout(() => {
            document.getElementById('transcript').textContent = '';
        }, 3000);
    }

    // Analisar comando de voz (mantido como estava)
    function parseVoiceCommand(text) {
        const patterns = [
            /(?:gastei|paguei|despesa de|comprei.*por|custou)\s*(\d+(?:,\d+)?)\s*reais?\s*(?:com|de|em|para)?\s*(.+)/i,
            /(\d+(?:,\d+)?)\s*reais?\s*(?:com|de|em|para)?\s*(.+)/i,
            /(.+)\s*(?:custou|por)\s*(\d+(?:,\d+)?)\s*reais?/i
        ];

        for (let pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
                const value = parseFloat(match[1].replace(',', '.'));
                let description = match[2].trim();
                
                const category = determineCategory(description);
                
                return {
                    value: value,
                    description: description,
                    category: category
                };
            }
        }
        return null;
    }

    // Determinar categoria automaticamente (mantido como estava)
    function determineCategory(description) {
        const categoryKeywords = {
            'alimentacao': ['almo√ßo', 'jantar', 'caf√©', 'comida', 'restaurante', 'lanche', 'supermercado', 'padaria'],
            'transporte': ['uber', 't√°xi', '√¥nibus', 'metr√¥', 'gasolina', 'combust√≠vel', 'estacionamento'],
            'saude': ['rem√©dio', 'm√©dico', 'farm√°cia', 'consulta', 'exame', 'hospital'],
            'lazer': ['cinema', 'show', 'festa', 'bar', 'divers√£o', 'jogo', 'teatro'],
            'casa': ['luz', '√°gua', 'g√°s', 'aluguel', 'condom√≠nio', 'internet', 'telefone'],
            'trabalho': ['material', 'escrit√≥rio', 'curso', 'livro', 'equipamento']
        };

        const desc = description.toLowerCase();
        for (let [category, keywords] of Object.entries(categoryKeywords)) {
            if (keywords.some(keyword => desc.includes(keyword))) {
                return category;
            }
        }
        return 'outros';
    }

    // Fun√ß√£o para formatar moeda brasileira (mantido como estava)
    function formatCurrency(value) {
        return value.toFixed(2).replace('.', ',');
    }

    // Adicionar despesa (AGORA SALVA NO SUPABASE)
    async function addExpense(description, value, category) {
        const newExpense = {
            description: description,
            value: value,
            category: category,
            // Supabase prefere datas em formato ISO ou timestamp.
            // Se sua coluna 'date' no Supabase for 'text', pode manter toLocaleDateString.
            // Se for 'date' ou 'timestamp', use new Date().toISOString().split('T')[0] ou new Date().toISOString()
            date: new Date().toLocaleDateString('pt-BR') 
        };

        const { data, error } = await supabase
            .from('expenses') // Nome da sua tabela no Supabase
            .insert([newExpense])
            .select(); // Retorna o item inserido com o ID gerado

        if (error) {
            console.error('Erro ao adicionar despesa no Supabase:', error);
            alert('Erro ao adicionar despesa. Verifique o console para mais detalhes.');
            return false;
        } else {
            // Adiciona a despesa retornada pelo Supabase (com o ID) ao array local
            // Garante que o valor √© um n√∫mero, caso o Supabase retorne como string
            expenses.unshift({
                ...data[0], 
                value: parseFloat(data[0].value) 
            });
            renderExpenses();
            updateTotal();
            console.log('Despesa adicionada no Supabase e localmente:', data[0]);
            return true;
        }
    }

    // Adicionar despesa manualmente (mantido como estava, mas chama a nova addExpense)
    async function addExpenseManually() { // Tornar async para esperar addExpense
        const description = document.getElementById('description').value.trim();
        const valueInput = document.getElementById('value').value;
        const category = document.getElementById('category').value;

        if (!description) {
            alert('Por favor, preencha a descri√ß√£o da despesa.');
            return;
        }

        const value = parseFloat(valueInput.replace(',', '.'));
        
        if (!valueInput || isNaN(value) || value <= 0) {
            alert('Por favor, preencha um valor v√°lido maior que zero.');
            return;
        }

        // Chama a fun√ß√£o addExpense que agora interage com o Supabase
        if (await addExpense(description, value, category)) { 
            document.getElementById('description').value = '';
            document.getElementById('value').value = '';
            document.getElementById('category').value = 'alimentacao';
        }
    }

    // Deletar despesa (AGORA DELETA DO SUPABASE)
    async function deleteExpense(id) { // Tornar async
        if (confirm('Tem certeza que deseja excluir esta despesa?')) {
            const { error } = await supabase
                .from('expenses') // Nome da sua tabela
                .delete()
                .eq('id', id); // Deleta onde o ID √© igual

            if (error) {
                console.error('Erro ao deletar despesa do Supabase:', error);
                alert('Erro ao deletar despesa. Verifique o console para mais detalhes.');
            } else {
                expenses = expenses.filter(expense => expense.id !== id);
                renderExpenses();
                updateTotal();
                console.log('Despesa deletada do Supabase e localmente:', id);
            }
        }
    }

    // Renderizar lista de despesas (mantido como estava)
    function renderExpenses() {
        const expensesList = document.getElementById('expensesList');
        
        if (expenses.length === 0) {
            expensesList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhuma despesa registrada ainda.</p>';
            return;
        }

        expensesList.innerHTML = expenses.map(expense => `
            <div class="expense-item">
                <div class="expense-details">
                    <div class="expense-category">${getCategoryName(expense.category)} ‚Ä¢ ${expense.date}</div>
                    <div class="expense-description">${expense.description}</div>
                </div>
                <div style="text-align: right;">
                    <div class="expense-value">R$ ${formatCurrency(expense.value)}</div>
                    <button class="delete-btn" onclick="deleteExpense(${expense.id})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    // Obter nome da categoria (mantido como estava)
    function getCategoryName(category) {
        const names = {
            'alimentacao': 'üçΩÔ∏è Alimenta√ß√£o',
            'transporte': 'üöó Transporte',
            'saude': 'üè• Sa√∫de',
            'lazer': 'üé≠ Lazer',
            'casa': 'üè† Casa',
            'trabalho': 'üíº Trabalho',
            'outros': 'üì¶ Outros'
        };
        return names[category] || 'üì¶ Outros';
    }

    // Mostrar ajuda sobre permiss√µes (COM A CORRE√á√ÉO DO REMOVECHILD)
    function showPermissionHelp() {
        // Evita criar m√∫ltiplos helps se j√° existir um
        if (document.getElementById('permissionHelp')) {
            return;
        }

        const helpDiv = document.createElement('div');
        helpDiv.id = 'permissionHelp';
        helpDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            max-width: 350px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        `;
        helpDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #856404;">üé§ Como permitir o microfone:</h4>
                <button onclick="document.getElementById('permissionHelp').remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">√ó</button>
            </div>
            <ol style="margin: 0; padding-left: 20px; color: #856404;">
                <li>Clique no √≠cone üîí ou üé§ na barra de endere√ßo</li>
                <li>Selecione "Permitir" para microfone</li>
                <li>Recarregue a p√°gina (F5)</li>
                <li>Tente usar o comando de voz novamente</li>
            </ol>
            <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #856404;">
                <strong>Dica:</strong> Se n√£o funcionar, tente usar no Chrome ou Edge
            </p>
        `;
        document.body.appendChild(helpDiv);
        
        // Remover automaticamente ap√≥s 10 segundos
        setTimeout(() => {
            const helpToRemove = document.getElementById('permissionHelp');
            // Verifica se o elemento existe E se ele ainda √© filho do body antes de tentar remover
            if (helpToRemove && document.body.contains(helpToRemove)) {
                document.body.removeChild(helpToRemove);
            }
        }, 10000);
    }

    // Atualizar total (mantido como estava, mas agora com dados do Supabase)
    function updateTotal() {
        const total = expenses.reduce((sum, expense) => sum + expense.value, 0);
        document.getElementById('totalValue').textContent = `R$ ${formatCurrency(total)}`;
    }

    // NOVO: Fun√ß√£o para carregar as despesas do Supabase
    async function loadExpenses() {
        const { data, error } = await supabase
            .from('expenses') // Nome da sua tabela no Supabase
            .select('*')
            .order('date', { ascending: false }); // Ordena como preferir

        if (error) {
            console.error('Erro ao carregar despesas do Supabase:', error);
            alert('Erro ao carregar despesas. Verifique o console para mais detalhes.');
            expenses = []; // Em caso de erro, inicializa vazio
        } else {
            // Converte os valores para n√∫mero se eles vierem como string do DB
            expenses = data.map(exp => ({
                ...exp,
                value: parseFloat(exp.value) 
            }));
            console.log('Despesas carregadas do Supabase:', expenses);
        }
    }

    // Event listeners (addExpenseManually agora √© async)
    document.getElementById('voiceBtn').addEventListener('click', function() {
        if (isListening) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch (error) {
                console.log('Reconhecimento j√° est√° ativo:', error);
                recognition.stop();
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Erro ao reiniciar reconhecimento:', e);
                    }
                }, 100);
            }
        }
    });

    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && (e.target.id === 'description' || e.target.id === 'value')) {
            addExpenseManually();
        }
    });

    // Inicializar aplica√ß√£o (AGORA CARREGA DO SUPABASE)
    window.onload = async function() { // Adicione 'async' aqui
        await loadExpenses(); // Aguarda o carregamento das despesas do Supabase
        initSpeechRecognition();
        renderExpenses();
        updateTotal();
        console.log('Aplica√ß√£o inicializada com Supabase.');
    };
</script>
